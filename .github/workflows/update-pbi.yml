name: Power BI Link Sync (Validated)
on:
  schedule:
    - cron: '15 0 * * *'
  workflow_dispatch:

jobs:
  update-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4 lxml

      - name: Fetch and Validate Links
        run: |
          python - <<EOF
          import requests
          import os
          from bs4 import BeautifulSoup
          from datetime import datetime

          HEADERS = {'User-Agent': 'Mozilla/5.0 (Linux; Android 14; SM-X910) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'}
          URL = "https://powerbi.microsoft.com/en-us/blog/feed/"
          FILENAME = "README.md"

          def is_link_working(url):
              try:
                  # This pings the link to see if it actually exists (Status 200)
                  # allow_redirects=True handles links that move to a new URL
                  response = requests.head(url, headers=HEADERS, timeout=10, allow_redirects=True)
                  return response.status_code == 200
              except:
                  return False

          def get_valid_links():
              try:
                  res = requests.get(URL, headers=HEADERS, timeout=20)
                  soup = BeautifulSoup(res.text, 'xml')
                  items = soup.find_all('item')[:5]
                  
                  valid_markdown_list = []
                  for item in items:
                      title = item.title.text.strip()
                      link = item.link.text.strip()
                      
                      # THE FIX: Only add the link if it passes the "is_link_working" test
                      if title and link and is_link_working(link):
                          valid_markdown_list.append(f"* [{title}]({link})")
                      else:
                          print(f"Skipping broken or invalid link: {link}")
                          
                  return valid_markdown_list
              except Exception as e:
                  print(f"Error fetching feed: {e}")
                  return []

          # Update File Logic
          new_posts = get_valid_links()
          if new_posts:
              today = datetime.now().strftime('%Y-%m-%d')
              new_content = f"## ðŸ“… Updates Pulled: {today}\n" + "\n".join(new_posts) + "\n\n---\n"
              
              old_data = ""
              if os.path.exists(FILENAME):
                  with open(FILENAME, "r") as f:
                      old_data = f.read().replace("# Power BI Link Archive", "").strip()
              
              with open(FILENAME, "w") as f:
                  f.write("# Power BI Link Archive\n\n" + new_content + "\n" + old_data)
          EOF

      - name: Commit and Push
        run: |
          git config user.name "Link Validator Bot"
          git config user.email "bot@github.com"
          git add README.md
          git commit -m "Updated Validated Links: $(date +'%Y-%m-%d')" || exit 0
          git push
