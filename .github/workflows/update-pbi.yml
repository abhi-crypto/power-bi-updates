name: Power BI Quick Link Sync (v3)
on:
  schedule:
    - cron: '15 0 * * *'
  workflow_dispatch:

jobs:
  update-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4 lxml

      - name: Fetch and Append Links
        run: |
          python - <<EOF
          import requests
          import os
          from bs4 import BeautifulSoup
          from datetime import datetime

          # 1. Config
          HEADERS = {'User-Agent': 'Mozilla/5.0 (Linux; Android 14; SM-X910) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'}
          URL = "https://powerbi.microsoft.com/en-us/blog/feed/"
          FILENAME = "README.md"

          def get_links():
              try:
                  res = requests.get(URL, headers=HEADERS, timeout=20)
                  # Use 'xml' parser to accurately read the RSS tags
                  soup = BeautifulSoup(res.text, 'xml')
                  items = soup.find_all('item')[:5] # Get top 5 posts
                  
                  new_markdown_list = []
                  for item in items:
                      title = item.title.text.strip()
                      # Microsoft feeds often put the link in <link> or <guid>
                      link = item.link.text.strip()
                      if title and link:
                          new_markdown_list.append(f"* [{title}]({link})")
                  return new_markdown_list
              except Exception as e:
                  print(f"Error: {e}")
                  return []

          # 2. Update File
          new_posts = get_links()
          if new_posts:
              today = datetime.now().strftime('%Y-%m-%d')
              new_content = f"## ðŸ“… Updates Pulled: {today}\n" + "\n".join(new_posts) + "\n\n---\n"
              
              # Read existing content
              old_data = ""
              if os.path.exists(FILENAME):
                  with open(FILENAME, "r") as f:
                      old_data = f.read().replace("# Power BI Link Archive", "").strip()
              
              # Prepend new content
              with open(FILENAME, "w") as f:
                  f.write("# Power BI Link Archive\n\n" + new_content + "\n" + old_data)
          EOF

      - name: Commit and Push
        run: |
          git config user.name "Link Bot"
          git config user.email "bot@github.com"
          git add README.md
          git commit -m "Fixed Link Sync: $(date +'%Y-%m-%d')" || exit 0
          git push
